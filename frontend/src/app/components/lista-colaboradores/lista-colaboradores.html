<!-- frontend/src/app/components/lista-colaboradores/lista-colaboradores.component.html -->

<div class="lista-colaboradores-container">

  <div class="controls-section">
    <!-- Barra de pesquisa à esquerda -->
    <div class="search-container">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Pesquisar por nome, e-mail ou CPF..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
        <button class="search-button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Botões à direita: Convidar + Exportar -->
    <div class="buttons-container">
      <!-- Botão de convite -->
      <button 
        class="invite-button" 
        (click)="openInviteDialog()"
        title="Convidar novo colaborador"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M5.25 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM2.25 19.125a7.875 7.875 0 0 1 15.75 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM18.75 7.5a.75.75 0 0 0-1.5 0v2.25H15a.75.75 0 0 0 0 1.5h2.25v2.25a.75.75 0 0 0 1.5 0v-2.25H21a.75.75 0 0 0 0-1.5h-2.25V7.5Z" />
        </svg>
        Convidar Colaborador
      </button>
      
      <!-- Botão de exportar -->
      <button class="export-button" (click)="exportToExcel()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.18 1.18 3.712 3.712 1.18-1.18a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.336 2.025l-.353 1.059A.75.75 0 0 0 5.003 18.5l1.059-.353a5.25 5.25 0 0 0 2.025-1.336l8.4-8.4Z" />
          <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
        </svg>
        Exportar para Excel
      </button>
    </div>
  </div>

  <!-- Tabela de Colaboradores -->
  <div class="table-responsive">
    <table class="colaboradores-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>E-mail</th>
          <th>CPF</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- Exibe uma mensagem de carregamento enquanto os dados são buscados -->
        <tr *ngIf="loading">
          <td colspan="4" class="text-center">Carregando colaboradores...</td>
        </tr>
        <!-- Exibe uma mensagem se não houver colaboradores -->
        <tr *ngIf="!loading && filteredColaboradores.length === 0">
          <td colspan="4" class="text-center">Nenhum colaborador encontrado.</td>
        </tr>
        <!-- Itera sobre a lista filtrada e paginada de colaboradores -->
        <tr *ngFor="let colaborador of paginatedColaboradores">
          <td>{{ colaborador.nome }}</td>
          <td>{{ colaborador.email }}</td>
          <td>{{ colaborador.cpf }}</td>
          <td>
            <button class="details-button" (click)="viewDetails(colaborador)">
              Detalhes
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Controles de Paginação -->
  <div class="pagination-controls">
    <button (click)="previousPage()" [disabled]="currentPage === 1">Anterior</button>
    <span>Página {{ currentPage }} de {{ totalPages }}</span>
    <button (click)="nextPage()" [disabled]="currentPage === totalPages">Próxima</button>
  </div>

  <!-- Dialog Modal para Detalhes do Colaborador -->
  <div class="modal-overlay" *ngIf="showColaboradorDialog" (click)="closeColaboradorDialog()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-circle"></i>
          Detalhes do Colaborador
        </h2>
        <button 
          type="button" 
          class="close-button" 
          (click)="closeColaboradorDialog()"
          aria-label="Fechar"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Conteúdo do Modal -->
      <div class="modal-body" *ngIf="selectedColaborador">
        <!-- Informações Pessoais -->
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-user"></i>
            Informações Pessoais
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <label>Nome Completo:</label>
              <span>{{ selectedColaborador.nome }}</span>
            </div>
            <div class="info-item">
              <label>E-mail:</label>
              <span>{{ selectedColaborador.email }}</span>
            </div>
            <div class="info-item">
              <label>CPF:</label>
              <span>{{ selectedColaborador.cpf }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.celular">
              <label>Celular:</label>
              <span>{{ selectedColaborador.celular }}</span>
            </div>
          </div>
        </div>

        <!-- Informações Profissionais -->
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-briefcase"></i>
            Informações Profissionais
          </h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="selectedColaborador.perfil">
              <label>Perfil de Acesso:</label>
              
              <!-- MODO NORMAL: Mostra badges lado a lado -->
              <div *ngIf="!isEditingProfile" class="perfil-badges-container">
                <span class="perfil-badge" [ngClass]="selectedColaborador.perfil | lowercase">
                  {{ selectedColaborador.perfil }}
                </span>
                <!-- Badge invisível para manter o layout -->
                <span class="perfil-badge invisible">Placeholder</span>
              </div>
              <!-- MODO EDIÇÃO: Substitui badges por select e botões -->
              <div *ngIf="isEditingProfile" class="perfil-edit-inline">
                <div class="perfil-select-container">
                  <select 
                    id="perfil-change-select"
                    name="perfil-change-select"
                    class="perfil-select"
                    [value]="getPerfilId(selectedColaborador?.perfil || '')"
                    (change)="onPerfilChange($event)"
                    [disabled]="isChangingProfile"
                    autocomplete="off"
                  >
                    <option *ngFor="let perfil of getPerfisPermitidos()" [value]="perfil.id">
                      {{ perfil.nome }}
                    </option>
                  </select>
                </div>
                
                <div class="perfil-actions">
                  <button 
                    type="button"
                    class="btn-perfil btn-cancel-perfil"
                    (click)="cancelEditingProfile()"
                    [disabled]="isChangingProfile"
                  >
                    <i class="fas fa-times"></i>
                    Cancelar
                  </button>
                  <button 
                    type="button"
                    class="btn-perfil btn-save-perfil"
                    (click)="saveProfileChange()"
                    [disabled]="isChangingProfile || (showPasswordField && (!newPassword || !confirmPassword))"
                  >
                    <span *ngIf="isChangingProfile" class="loading-spinner-inline"></span>
                    <i *ngIf="!isChangingProfile" class="fas fa-check"></i>
                    {{ isChangingProfile ? 'Salvando...' : 'Salvar' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Campo de Senha (aparece apenas quando necessário) -->
        <div class="info-section" *ngIf="showPasswordField">
          <h3 class="section-title">
            <i class="fas fa-key"></i>
            Configuração de Acesso
          </h3>
          <div class="password-form">
            <p class="password-info">
              <i class="fas fa-info-circle"></i>
              Este perfil requer acesso ao sistema. Defina uma senha para o colaborador:
            </p>
            <div class="info-grid">
              <div class="info-item">
                <label for="perfil-new-password">Nova Senha:</label>
                <input 
                  id="perfil-new-password"
                  name="perfil-new-password"
                  type="password" 
                  class="form-control"
                  [(ngModel)]="newPassword"
                  placeholder="Mínimo 6 caracteres"
                  [disabled]="isChangingProfile"
                  autocomplete="new-password"
                  autocorrect="off"
                  autocapitalize="off"
                  spellcheck="false"
                >
              </div>
              <div class="info-item">
                <label for="perfil-confirm-password">Confirmar Senha:</label>
                <input 
                  id="perfil-confirm-password"
                  name="perfil-confirm-password"
                  type="password" 
                  class="form-control"
                  [(ngModel)]="confirmPassword"
                  placeholder="Confirme a senha"
                  [disabled]="isChangingProfile"
                  autocomplete="new-password"
                  autocorrect="off"
                  autocapitalize="off"
                  spellcheck="false"
                >
              </div>
            </div>
            
            <!-- Mensagens de erro da senha -->
            <div class="password-errors" *ngIf="passwordError">
              <small class="error-text">{{ passwordError }}</small>
            </div>
          </div>
        </div>

        <!-- Endereço -->
        <div class="info-section" *ngIf="selectedColaborador.cep || selectedColaborador.logradouro">
          <h3 class="section-title">
            <i class="fas fa-map-marker-alt"></i>
            Endereço
          </h3>
          <div class="info-grid">
            <div class="info-item" *ngIf="selectedColaborador.logradouro">
              <label>Logradouro:</label>
              <span>{{ selectedColaborador.logradouro }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.bairro">
              <label>Bairro:</label>
              <span>{{ selectedColaborador.bairro }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.localidade">
              <label>Cidade:</label>
              <span>{{ selectedColaborador.localidade }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.uf">
              <label>UF:</label>
              <span>{{ selectedColaborador.uf }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.cep">
              <label>CEP:</label>
              <span>{{ selectedColaborador.cep }}</span>
            </div>
          </div>
        </div>

        <!-- Mensagens de feedback -->
        <div class="message-container" *ngIf="profileChangeSuccess || profileChangeError">
          <div *ngIf="profileChangeSuccess" class="success-message">
            <i class="fas fa-check-circle"></i>
            {{ profileChangeSuccess }}
          </div>
          
          <div *ngIf="profileChangeError" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            {{ profileChangeError }}
          </div>
        </div>
      </div>

      <!-- Footer do Modal -->
      <div class="modal-footer">
        <!-- Botão "Alterar Perfil" -->
        <div *ngIf="!isEditingProfile" class="modal-footer-normal">        
          <!-- Botão "Alterar Perfil" (só aparece se usuário pode alterar) -->
          <button 
            *ngIf="canChangeProfile()"
            type="button"
            class="btn btn-primary"
            (click)="startEditingProfile()"
          >
            <i class="fas fa-user-cog"></i>
            Alterar Perfil
          </button>
        </div>

        <!-- Modo edição: vazio (select e botões estão no lugar do badge) -->
        <div *ngIf="isEditingProfile" class="modal-footer-edit">
          <!-- Vazio - controles estão inline no lugar do badge -->
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog Modal para Convite de Colaborador -->
  <div class="modal-overlay" *ngIf="showInviteDialog" (click)="closeInviteDialog()">
    <div class="modal-dialog invite-dialog" (click)="$event.stopPropagation()">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h2 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path d="M1.5 8.67v8.58a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3V8.67l-8.928 5.493a3 3 0 0 1-3.144 0L1.5 8.67Z" />
            <path d="M22.5 6.908V6.75a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3v.158l9.714 5.978a1.5 1.5 0 0 0 1.572 0L22.5 6.908Z" />
          </svg>
          Convidar Colaborador
        </h2>
        <button 
          type="button" 
          class="close-button" 
          (click)="closeInviteDialog()"
          aria-label="Fechar"
        >
        </button>
      </div>

      <!-- Conteúdo do Modal -->
      <div class="modal-body">
        <form (ngSubmit)="sendInvite()" #inviteForm="ngForm">
          <div class="form-group">
            <label for="inviteEmail">E-mail do colaborador:</label>
            <input
              type="email"
              id="inviteEmail"
              name="inviteEmail"
              [(ngModel)]="inviteEmail"
              #emailInput="ngModel"
              required
              email
              class="form-control"
              [class.error]="emailInput.invalid && emailInput.touched"
              placeholder="Digite o e-mail do colaborador"
              autocomplete="email"
            >
            
            <!-- Mensagens de validação -->
            <div class="error-messages" *ngIf="emailInput.invalid && emailInput.touched">
              <small *ngIf="emailInput.errors?.['required']" class="error-text">
                O e-mail é obrigatório.
              </small>
              <small *ngIf="emailInput.errors?.['email']" class="error-text">
                Por favor, digite um e-mail válido.
              </small>
            </div>
          </div>

          <!-- Mensagens de sucesso/erro -->
          <div class="message-container">
            <div *ngIf="inviteSuccessMessage" class="success-message">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
              </svg>
              {{ inviteSuccessMessage }}
            </div>
            
            <div *ngIf="inviteErrorMessage" class="error-message">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" />
              </svg>
              {{ inviteErrorMessage }}
            </div>
          </div>

          <!-- Botões do footer -->
          <div class="invite-modal-buttons">
            <button 
              type="button" 
              class="btn btn-cancel" 
              (click)="closeInviteDialog()"
              [disabled]="inviteLoading"
            >
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-send" 
              [disabled]="inviteForm.invalid || inviteLoading"
            >
              <span *ngIf="inviteLoading" class="loading-spinner"></span>
              {{ inviteLoading ? 'Enviando...' : 'Enviar Convite' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
