<!-- frontend/src/app/components/lista-colaboradores/lista-colaboradores.component.html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<div
  class="lista-colaboradores-container"
  role="main"
  aria-label="Lista de Colaboradores"
>
  <div class="controls-section">
    <!-- Barra de pesquisa à esquerda -->
    <div class="search-container">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Pesquisar por nome, e-mail ou CPF..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          aria-label="Campo de pesquisa de colaboradores por nome, e-mail ou CPF"
        />
        <button class="search-button" aria-label="Iniciar Pesquisa">
          <svg
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-5 h-5"
          >
            <path
              fill-rule="evenodd"
              d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Botões à direita: Exportar -->
    <div class="buttons-container">
      <button
        class="export-button"
        (click)="exportToExcel()"
        aria-label="Exportar dados para planilha Excel"
      >
        <svg
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-5 h-5"
        >
          <path
            d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.18 1.18 3.712 3.712 1.18-1.18a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.336 2.025l-.353 1.059A.75.75 0 0 0 5.003 18.5l1.059-.353a5.25 5.25 0 0 0 2.025-1.336l8.4-8.4Z"
          />
          <path
            d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
          />
        </svg>
        Exportar para Excel
      </button>
    </div>
  </div>

  <!-- Tabela de Colaboradores -->
  <div class="table-responsive">
    <table
      class="colaboradores-table"
      aria-label="Lista de colaboradores da empresa"
    >
      <thead>
        <tr>
          <th>Nome</th>
          <th>E-mail</th>
          <th>CPF</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- Exibe uma mensagem de carregamento enquanto os dados são buscados -->
        <tr *ngIf="loading">
          <td colspan="4" class="text-center">Carregando colaboradores...</td>
        </tr>
        <!-- Exibe uma mensagem se não houver colaboradores -->
        <tr *ngIf="!loading && filteredColaboradores.length === 0">
          <td colspan="4" class="text-center">
            Nenhum colaborador encontrado.
          </td>
        </tr>
        <!-- Itera sobre a lista filtrada e paginada de colaboradores -->
        <tr *ngFor="let colaborador of paginatedColaboradores; trackBy: trackByColaborador">
          <td>{{ colaborador.nome }}</td>
          <td>{{ colaborador.email }}</td>
          <td>{{ colaborador.cpf }}</td>
          <td>
            <button
              class="details-button"
              (click)="viewDetails(colaborador)"
              aria-label="Ver detalhes de {{ colaborador.nome }}"
              title="Ver detalhes de {{ colaborador.nome }}"
            >
              Detalhes
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- PAGINAÇÃO -->
  <div class="pagination-container" *ngIf="!loading && totalItems > 0">
    <div class="pagination-info">
      <div class="items-per-page">
        <label for="itemsPerPage">Itens por página:</label>
        <select
          id="itemsPerPage"
          [(ngModel)]="itemsPerPage"
          (change)="updateItemsPerPage()"
        >
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>

    <div class="pagination-range">
      <span
        >{{ getStartIndex() }} - {{ getEndIndex() }} de {{ totalItems }}</span
      >
    </div>

    <div class="pagination-controls">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="goToPage(1)"
        title="Primeira página"
        aria-label="Ir para a primeira página"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m11 17-5-5 5-5M18 17l-5-5 5-5" />
        </svg>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="goToPrevious()"
        title="Página anterior"
        aria-label="Ir para a página anterior"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m15 18-6-6 6-6" />
        </svg>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToNext()"
        title="Próxima página"
        aria-label="Ir para a próxima página"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m9 18 6-6-6-6" />
        </svg>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(totalPages)"
        title="Última página"
        aria-label="Ir para a última página"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="m6 17 5-5-5-5M13 17l5-5-5-5" />
        </svg>
      </button>
    </div>
  </div>
</div>

<div
  class="modal-overlay"
  *ngIf="showColaboradorDialog"
  (click)="closeColaboradorDialog()"
  role="dialog"
  aria-modal="true"
  aria-labelledby="colaboradorModalTitle"
>
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <!-- Header do Modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="colaboradorModalTitle">
        <i class="fas fa-user-circle" aria-hidden="true"></i>
        Detalhes do Colaborador
      </h2>
      <button
        type="button"
        class="close-button"
        (click)="closeColaboradorDialog()"
        aria-label="Fechar janela de detalhes do colaborador"
      >
        <i class="fas fa-times" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Conteúdo do Modal -->
    <div class="modal-body" *ngIf="selectedColaborador">
      <div class="info-sections-container">
        <!-- Informações Pessoais (Esquerda) - Layout 2x2 -->
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-user" aria-hidden="true"></i> Informações Pessoais
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <label>Nome Completo:</label>
              <span>{{ selectedColaborador.nome }}</span>
            </div>
            <div class="info-item">
              <label>CPF:</label>
              <span>{{ selectedColaborador.cpf }}</span>
            </div>
            
            <div class="info-item">
              <label>E-mail:</label>
              <span>{{ selectedColaborador.email }}</span>
            </div>
            <div class="info-item" *ngIf="selectedColaborador.celular; else emptyCell">
              <label>Celular:</label>
              <span>{{ selectedColaborador.celular }}</span>
            </div>
            <ng-template #emptyCell>
              <div class="info-item">
                <label>Celular:</label>
                <span>Não informado</span>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- LINHA DIVISÓRIA VERTICAL -->
        <div class="vertical-divider"></div>

        <!-- Informações Profissionais (Direita) -->
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-briefcase" aria-hidden="true"></i> Informações Profissionais
          </h3>
          <div class="info-grid single-column">
            <div class="info-item" *ngIf="selectedColaborador.perfil">
              <label>Perfil de Acesso:</label>

              <div *ngIf="!isEditingProfile" class="perfil-badges-container">
                <span
                  class="perfil-badge"
                  [ngClass]="selectedColaborador.perfil | lowercase"
                >
                  {{ selectedColaborador.perfil }}
                </span>
              </div>

              <!-- MODO EDIÇÃO: Substitui badges por select e botões -->
              <div *ngIf="isEditingProfile" class="perfil-edit-inline">
                <div class="perfil-select-container">
                  <select
                    id="perfil-change-select"
                    name="perfil-change-select"
                    class="perfil-select"
                    [value]="getPerfilId(selectedColaborador?.perfil || '')"
                    (change)="onPerfilChange($event)"
                    [disabled]="isChangingProfile"
                    autocomplete="off"
                    aria-label="Selecionar novo perfil de acesso"
                  >
                    <option
                      *ngFor="let perfil of getPerfisPermitidos()"
                      [value]="perfil.id"
                    >
                      {{ perfil.nome }}
                    </option>
                  </select>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SEÇÃO DE CURSOS ASSOCIADOS -->
      <div
        class="info-section full-width"
        *ngIf="selectedColaborador && selectedColaborador.perfil === 'Elaborador de Itens'"
      >
        <h3 class="section-title">
          <i class="fas fa-graduation-cap" aria-hidden="true"></i> Cursos Associados
        </h3>

        <!-- MODO VISUALIZAÇÃO -->
        <div *ngIf="!isManagingCursos" class="cursos-view-mode">
          <!-- Lista de cursos atuais -->
          <div
            class="cursos-list"
            *ngIf="
              selectedColaborador.cursos &&
              selectedColaborador.cursos.length > 0
            "
          >
            <div
              class="curso-item-readonly"
              *ngFor="let curso of selectedColaborador.cursos"
            >
              <div class="curso-info">
                <span class="curso-nome">{{ curso.nome }}</span>
                <span
                  class="curso-status"
                  [class]="curso.status ? 'ativo' : 'inativo'"
                >
                  <i class="fas fa-circle"></i> {{ curso.status ? 'Ativo' : 'Inativo' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Mensagem quando não há cursos -->
          <div
            class="no-cursos"
            *ngIf="
              !selectedColaborador.cursos ||
              selectedColaborador.cursos.length === 0
            "
          >
            <i class="fas fa-info-circle"></i>
            <span>Nenhum curso associado a este elaborador.</span>
          </div>
        </div>

        <!-- MODO GERENCIAMENTO -->
        <div *ngIf="isManagingCursos" class="cursos-manage-mode">
          <div class="add-curso-section">
            <h4><i class="fas fa-plus-circle"></i> Associar Novo Curso</h4>
            <div class="add-curso-form">
              <div class="curso-select-container">
                <input
                  type="text"
                  class="curso-search-input"
                  placeholder="Digite para pesquisar ou selecione um curso..."
                  [(ngModel)]="cursoSearchTerm"
                  (input)="onCursoSearch()"
                  (focus)="onCursoInputFocus()"
                  [disabled]="cursosLoading"
                />
                <div class="curso-dropdown" *ngIf="showCursoDropdown && (filteredCursosDisponiveis.length > 0 || (cursoSearchTerm && filteredCursosDisponiveis.length === 0))">
                  <div
                    *ngIf="filteredCursosDisponiveis.length === 0 && cursoSearchTerm"
                    class="curso-dropdown-item no-results"
                  >
                    Nenhum curso encontrado
                  </div>
                  <div
                    *ngFor="let curso of filteredCursosDisponiveis"
                    class="curso-dropdown-item"
                    (click)="selectCurso(curso)"
                  >
                    {{ curso.nome }}
                  </div>
                </div>
              </div>
              <button
                type="button"
                class="btn-action btn-add"
                (click)="addCursoToColaborador()"
                [disabled]="!selectedCursoToAdd || cursosLoading"
              >
                <span *ngIf="cursosLoading" class="loading-spinner-inline"></span>
                <i *ngIf="!cursosLoading" class="fas fa-plus"></i>
                Associar
              </button>
            </div>
          </div>

          <!-- Lista de cursos para gerenciar -->
          <div class="manage-cursos-section">
            <h4><i class="fas fa-list"></i> Cursos Atuais</h4>
            <div
              class="cursos-list-manage"
              *ngIf="selectedColaboradorCursos.length > 0"
            >
              <div
                class="curso-item-manage"
                *ngFor="let curso of selectedColaboradorCursos"
              >
                <div class="curso-info">
                  <span class="curso-nome">{{ curso.nome }}</span>
                  <span
                    class="curso-status"
                    [class]="curso.status ? 'ativo' : 'inativo'"
                  >
                    <i class="fas fa-circle"></i> {{ curso.status ? 'Ativo' : 'Inativo' }}
                  </span>
                </div>
                <button
                  class="curso-remove-btn"
                  (click)="removeCursoFromColaborador(curso.id)"
                  [disabled]="cursosLoading"
                  title="Remover curso"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            <div
              class="no-cursos-manage"
              *ngIf="selectedColaboradorCursos.length === 0"
            >
              <i class="fas fa-info-circle"></i>
              <span>Nenhum curso associado.</span>
            </div>
          </div>

        </div>

        <!-- Mensagens de cursos -->
        <div class="message-container" *ngIf="cursosSuccess || cursosError">
          <div *ngIf="cursosSuccess" class="success-message">
            <i class="fas fa-check-circle"></i> {{ cursosSuccess }}
          </div>
          <div *ngIf="cursosError" class="error-message">
            <i class="fas fa-exclamation-circle"></i> {{ cursosError }}
          </div>
        </div>
      </div>

      <!-- Mensagens de feedback -->
      <div
        class="message-container"
        *ngIf="profileChangeSuccess || profileChangeError"
      >
        <div *ngIf="profileChangeSuccess" class="success-message">
          <i class="fas fa-check-circle" aria-hidden="true"></i>
          {{ profileChangeSuccess }}
        </div>

        <div *ngIf="profileChangeError" class="error-message">
          <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
          {{ profileChangeError }}
        </div>
      </div>
    </div>

    <!-- FOOTER DO MODAL - BOTÕES DINÂMICOS -->
    <div class="modal-footer">
      <div class="modal-actions">
        
        <!-- MODO NORMAL: Botões principais -->
        <ng-container *ngIf="!isEditingProfile && !isManagingCursos">
          <!-- Botão Alterar Perfil -->
          <button
            *ngIf="canChangeProfile()"
            type="button"
            class="btn btn-primary"
            (click)="startEditingProfile()"
          >
            <i class="fas fa-user-cog" aria-hidden="true"></i>
            Alterar Perfil
          </button>

          <!-- Botão Gerenciar Cursos -->
          <button
            *ngIf="selectedColaborador && selectedColaborador.perfil === 'Elaborador de Itens'"
            type="button"
            class="btn btn-secondary"
            (click)="startManagingCursos()"
          >
            <i class="fas fa-graduation-cap" aria-hidden="true"></i>
            Gerenciar Cursos
          </button>
        </ng-container>

        <!-- MODO EDIÇÃO DE PERFIL: Botões de perfil -->
        <ng-container *ngIf="isEditingProfile">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="cancelEditingProfile()"
            [disabled]="isChangingProfile"
            aria-label="Cancelar alteração de perfil"
          >
            <i class="fas fa-times" aria-hidden="true"></i>
            Cancelar
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveProfileChange()"
            [disabled]="isChangingProfile"
            aria-label="Salvar alterações no perfil"
          >
            <span
              *ngIf="isChangingProfile"
              class="loading-spinner-inline"
              role="status"
              aria-label="Salvando alterações"
            ></span>
            <i
              *ngIf="!isChangingProfile"
              class="fas fa-check"
              aria-hidden="true"
            ></i>
            {{ isChangingProfile ? "Salvando..." : "Salvar" }}
          </button>
        </ng-container>

        <!-- MODO GERENCIAMENTO DE CURSOS: Botões de cursos -->
        <ng-container *ngIf="isManagingCursos">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="cancelManagingCursos()"
            [disabled]="cursosLoading"
          >
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveManagingCursos()"
            [disabled]="cursosLoading"
          >
            <span *ngIf="cursosLoading" class="loading-spinner-inline"></span>
            <i *ngIf="!cursosLoading" class="fas fa-check" aria-hidden="true"></i>
            {{ cursosLoading ? 'Salvando...' : 'Salvar Alterações' }}
          </button>
        </ng-container>

      </div>
    </div>
  </div>
</div>
