<!-- frontend/src/app/components/lista-colaboradores/lista-colaboradores.component.html -->

<div class="lista-colaboradores-container" role="main" aria-label="Lista de Colaboradores">

    <div class="controls-section">
        <!-- Barra de pesquisa à esquerda -->
        <div class="search-container">
            <div class="search-bar">
                <input type="text" placeholder="Pesquisar por nome, e-mail ou CPF..." [(ngModel)]="searchTerm" (input)="onSearchChange()" aria-label="Campo de pesquisa de colaboradores por nome, e-mail ou CPF" />
                <button class="search-button" aria-label="Iniciar Pesquisa">
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
          </svg>
        </button>
            </div>
        </div>

        <!-- Botões à direita: Convidar + Exportar -->
        <div class="buttons-container">
            <!-- Botão de convite -->
            <button class="invite-button" (click)="openInviteDialog()" title="Convidar novo colaborador" aria-label="Convidar novo colaborador">
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M5.25 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM2.25 19.125a7.875 7.875 0 0 1 15.75 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM18.75 7.5a.75.75 0 0 0-1.5 0v2.25H15a.75.75 0 0 0 0 1.5h2.25v2.25a.75.75 0 0 0 1.5 0v-2.25H21a.75.75 0 0 0 0-1.5h-2.25V7.5Z" />
        </svg>
        Convidar Colaborador
      </button>

            <!-- Botão de exportar -->
            <button class="export-button" (click)="exportToExcel()" aria-label="Exportar dados para planilha Excel">
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.18 1.18 3.712 3.712 1.18-1.18a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.336 2.025l-.353 1.059A.75.75 0 0 0 5.003 18.5l1.059-.353a5.25 5.25 0 0 0 2.025-1.336l8.4-8.4Z" />
          <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
        </svg>
        Exportar para Excel
      </button>
        </div>
    </div>

    <!-- Tabela de Colaboradores -->
    <div class="table-responsive">
        <table class="colaboradores-table" aria-label="Lista de colaboradores da empresa">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>CPF</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Exibe uma mensagem de carregamento enquanto os dados são buscados -->
                <tr *ngIf="loading">
                    <td colspan="4" class="text-center">Carregando colaboradores...</td>
                </tr>
                <!-- Exibe uma mensagem se não houver colaboradores -->
                <tr *ngIf="!loading && filteredColaboradores.length === 0">
                    <td colspan="4" class="text-center">Nenhum colaborador encontrado.</td>
                </tr>
                <!-- Itera sobre a lista filtrada e paginada de colaboradores -->
                <tr *ngFor="let colaborador of paginatedColaboradores">
                    <td>{{ colaborador.nome }}</td>
                    <td>{{ colaborador.email }}</td>
                    <td>{{ colaborador.cpf }}</td>
                    <td>
                        <button class="details-button" (click)="viewDetails(colaborador)" aria-label="Ver detalhes de {{ colaborador.nome }}" title="Ver detalhes de {{ colaborador.nome }}">
              Detalhes
            </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Dialog Modal para Detalhes do Colaborador -->
    <div class="modal-overlay" *ngIf="showColaboradorDialog" (click)="closeColaboradorDialog()" role="dialog" aria-modal="true" aria-labelledby="colaboradorModalTitle">
        <div class="modal-dialog" (click)="$event.stopPropagation()">
            <!-- Header do Modal -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-user-circle" aria-hidden="true"></i> Detalhes do Colaborador
                </h2>
                <button type="button" class="close-button" (click)="closeColaboradorDialog()" aria-label="Fechar janela de detalhes do colaborador">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="modal-body" *ngIf="selectedColaborador">
                <!-- Informações Pessoais -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-user" aria-hidden="true"></i> Informações Pessoais
                    </h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Nome Completo:</label>
                            <span>{{ selectedColaborador.nome }}</span>
                        </div>
                        <div class="info-item">
                            <label>E-mail:</label>
                            <span>{{ selectedColaborador.email }}</span>
                        </div>
                        <div class="info-item">
                            <label>CPF:</label>
                            <span>{{ selectedColaborador.cpf }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedColaborador.celular">
                            <label>Celular:</label>
                            <span>{{ selectedColaborador.celular }}</span>
                        </div>
                    </div>
                </div>

                <!-- Informações Profissionais -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-briefcase" aria-hidden="true"></i> Informações Profissionais
                    </h3>
                    <div class="info-grid">
                        <div class="info-item" *ngIf="selectedColaborador.perfil">
                            <label>Perfil de Acesso:</label>

                            <!-- MODO NORMAL: Mostra badges lado a lado -->
                            <div *ngIf="!isEditingProfile" class="perfil-badges-container">
                                <span class="perfil-badge" [ngClass]="selectedColaborador.perfil | lowercase">
                  {{ selectedColaborador.perfil }}
                </span>
                                <!-- Badge invisível para manter o layout -->
                                <span class="perfil-badge invisible">Placeholder</span>
                            </div>
                            <!-- MODO EDIÇÃO: Substitui badges por select e botões -->
                            <div *ngIf="isEditingProfile" class="perfil-edit-inline">
                                <div class="perfil-select-container">
                                    <select id="perfil-change-select" name="perfil-change-select" class="perfil-select" [value]="getPerfilId(selectedColaborador?.perfil || '')" (change)="onPerfilChange($event)" [disabled]="isChangingProfile" autocomplete="off">
                    <option *ngFor="let perfil of getPerfisPermitidos()" [value]="perfil.id">
                      {{ perfil.nome }}
                    </option>
                  </select>
                                </div>

                                <div class="perfil-actions">
                                    <button type="button" class="btn-perfil btn-cancel-perfil" (click)="cancelEditingProfile()" [disabled]="isChangingProfile">
                    <i class="fas fa-times" aria-hidden="true"></i>
                    Cancelar
                  </button>
                                    <button type="button" class="btn-perfil btn-save-perfil" (click)="saveProfileChange()" [disabled]="isChangingProfile || (showPasswordField && (!newPassword || !confirmPassword))" aria-label="Salvar alterações no perfil">
                    <span *ngIf="isChangingProfile" class="loading-spinner-inline" role="status" aria-label="Salvando alterações"></span>
                    <i *ngIf="!isChangingProfile" class="fas fa-check" aria-hidden="true"></i>
                    {{ isChangingProfile ? 'Salvando...' : 'Salvar' }}
                  </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campo de Senha (aparece apenas quando necessário) -->
                <div class="info-section" *ngIf="showPasswordField">
                    <h3 class="section-title">
                        <i class="fas fa-key"></i> Configuração de Acesso
                    </h3>
                    <div class="password-form">
                        <p class="password-info">
                            <i class="fas fa-info-circle"></i> Este perfil requer acesso ao sistema. Defina uma senha para o colaborador:
                        </p>
                        <div class="info-grid">
                            <div class="info-item">
                                <label for="perfil-new-password">Nova Senha:</label>
                                <input id="perfil-new-password" name="perfil-new-password" type="password" class="form-control" [(ngModel)]="newPassword" placeholder="Mínimo 6 caracteres" [disabled]="isChangingProfile" autocomplete="new-password" autocorrect="off" autocapitalize="off"
                                    spellcheck="false">
                            </div>
                            <div class="info-item">
                                <label for="perfil-confirm-password">Confirmar Senha:</label>
                                <input id="perfil-confirm-password" name="perfil-confirm-password" type="password" class="form-control" [(ngModel)]="confirmPassword" placeholder="Confirme a senha" [disabled]="isChangingProfile" autocomplete="new-password" autocorrect="off" autocapitalize="off"
                                    spellcheck="false">
                            </div>
                        </div>

                        <!-- Mensagens de erro da senha -->
                        <div class="password-errors" *ngIf="passwordError">
                            <small class="error-text">{{ passwordError }}</small>
                        </div>
                    </div>
                </div>

                <!-- Endereço -->
                <div class="info-section" *ngIf="selectedColaborador.cep || selectedColaborador.logradouro">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i> Endereço
                    </h3>
                    <div class="info-grid">
                        <div class="info-item" *ngIf="selectedColaborador.logradouro">
                            <label>Logradouro:</label>
                            <span>{{ selectedColaborador.logradouro }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedColaborador.bairro">
                            <label>Bairro:</label>
                            <span>{{ selectedColaborador.bairro }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedColaborador.localidade">
                            <label>Cidade:</label>
                            <span>{{ selectedColaborador.localidade }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedColaborador.uf">
                            <label>UF:</label>
                            <span>{{ selectedColaborador.uf }}</span>
                        </div>
                        <div class="info-item" *ngIf="selectedColaborador.cep">
                            <label>CEP:</label>
                            <span>{{ selectedColaborador.cep }}</span>
                        </div>
                    </div>
                </div>

                <!-- Mensagens de feedback -->
                <div class="message-container" *ngIf="profileChangeSuccess || profileChangeError">
                    <div *ngIf="profileChangeSuccess" class="success-message">
                        <i class="fas fa-check-circle"></i> {{ profileChangeSuccess }}
                    </div>

                    <div *ngIf="profileChangeError" class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ profileChangeError }}
                    </div>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="modal-footer">
                <!-- Botão "Alterar Perfil" -->
                <div *ngIf="!isEditingProfile" class="modal-footer-normal">
                    <!-- Botão "Alterar Perfil" (só aparece se usuário pode alterar) -->
                    <button *ngIf="canChangeProfile()" type="button" class="btn btn-primary" (click)="startEditingProfile()">
            <i class="fas fa-user-cog"></i>
            Alterar Perfil
          </button>
                </div>

                <!-- Modo edição: vazio (select e botões estão no lugar do badge) -->
                <div *ngIf="isEditingProfile" class="modal-footer-edit">
                    <!-- Vazio - controles estão inline no lugar do badge -->
                </div>
            </div>
        </div>
    </div>

    <!-- Dialog Modal para Convite de Colaborador -->
    <!-- Modal de Convite -->
    <div class="modal-overlay" *ngIf="showInviteDialog" (click)="closeInviteDialog()">
        <div class="modal-dialog invite-dialog" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" fill="currentColor"/>
            <path d="M12 14C7.58172 14 4 17.5817 4 22H20C20 17.5817 16.4183 14 12 14Z" fill="currentColor"/>
          </svg> Convidar Colaborador
                </h2>
                <button type="button" class="close-button" (click)="closeInviteDialog()" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form (ngSubmit)="sendInvite()" #inviteForm="ngForm">

                    <!-- Campo de E-mail -->
                    <div class="form-group">
                        <label for="inviteEmail">E-mail do colaborador: <span class="required">*</span></label>
                        <input type="email" id="inviteEmail" name="inviteEmail" [(ngModel)]="inviteEmail" #emailInput="ngModel" required email class="form-control" [class.error]="emailInput.invalid && emailInput.touched" placeholder="Digite o e-mail do colaborador" autocomplete="email"
                            (ngModelChange)="onEmailChange()">
                        <div class="error-messages" *ngIf="emailInput.invalid && emailInput.touched">
                            <small *ngIf="emailInput.errors?.['required']" class="error-text">
                O e-mail é obrigatório.
              </small>
                            <small *ngIf="emailInput.errors?.['email']" class="error-text">
                Por favor, digite um e-mail válido.
              </small>
                        </div>
                    </div>

                    <!-- NOVO Campo de Perfil -->
                    <div class="form-group">
                        <label for="invitePerfilSelect">Perfil de acesso: <span class="required">*</span></label>
                        <select id="invitePerfilSelect" name="invitePerfilSelect" [(ngModel)]="selectedPerfilConvite" #perfilSelect="ngModel" required class="form-control form-select" [class.error]="perfilSelect.invalid && perfilSelect.touched" (change)="onPerfilConviteChange($event)">
              <option value="0" disabled>Selecione um perfil</option>
              <option *ngFor="let perfil of perfisConvite" [value]="perfil.id">
                {{ perfil.nome }}
              </option>
            </select>
                        <div class="error-messages" *ngIf="perfilSelect.invalid && perfilSelect.touched">
                            <small *ngIf="perfilSelect.errors?.['required']" class="error-text">
                O perfil é obrigatório.
              </small>
                        </div>
                    </div>

                    <!-- NOVO Campo de Curso -->
                    <div class="form-group">
                        <label for="inviteCursoSelect">Curso: <span class="required">*</span></label>
                        <select id="inviteCursoSelect" name="inviteCursoSelect" [(ngModel)]="selectedCursoConvite" #cursoSelect="ngModel" required class="form-control form-select" [class.error]="cursoSelect.invalid && cursoSelect.touched" (change)="onCursoConviteChange($event)">
              <option value="0" disabled>Selecione um curso</option>
              <option *ngFor="let curso of cursosConvite" [value]="curso.id">
                {{ curso.nome }}
              </option>
            </select>
                        <div class="error-messages" *ngIf="cursoSelect.invalid && cursoSelect.touched">
                            <small *ngIf="cursoSelect.errors?.['required']" class="error-text">
                O curso é obrigatório.
              </small>
                        </div>
                    </div>

                    <!-- Mensagens de Sucesso/Erro -->
                    <div class="message-container">
                        <div *ngIf="inviteSuccessMessage" class="success-message">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg> {{ inviteSuccessMessage }}
                        </div>
                        <div *ngIf="inviteErrorMessage" class="error-message">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg> {{ inviteErrorMessage }}
                        </div>
                    </div>

                    <!-- BotõeS-->
                    <div class="invite-modal-buttons">
                        <button type="button" class="btn btn-cancel" (click)="closeInviteDialog()" [disabled]="inviteLoading">
              Cancelar
            </button>
                        <button type="submit" class="btn btn-send" [disabled]="inviteForm.invalid || inviteLoading">
              <span *ngIf="inviteLoading" class="loading-spinner"></span>
              {{ inviteLoading ? 'Enviando...' : 'Enviar Convite' }}
            </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Paginator customizado -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="items-per-page">
                <label for="itemsPerPage">Itens por página:</label>
                <select id="itemsPerPage" [(ngModel)]="itemsPerPage" (change)="updateItemsPerPage()">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
            </div>
        </div>

        <div class="pagination-range">
            <span>{{ getStartIndex() }} - {{ getEndIndex() }} de {{ totalItems }}</span>
        </div>

        <div class="pagination-controls">
            <button class="pagination-btn" [disabled]="currentPage === 1" (click)="goToPage(1)" title="Primeira página">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m11 17-5-5 5-5M18 17l-5-5 5-5"/>
        </svg>
      </button>

            <button class="pagination-btn" [disabled]="currentPage === 1" (click)="goToPrevious()" title="Página anterior">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m15 18-6-6 6-6"/>
        </svg>
      </button>

            <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="goToNext()" title="Próxima página">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"/>
        </svg>
      </button>

            <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="goToPage(totalPages)" title="Última página">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m6 17 5-5-5-5M13 17l5-5-5-5"/>
        </svg>
      </button>
        </div>
    </div>

</div>